{"id":"5c3c04e2be23a10017086e8d","title":"io.js の fs.readFileSync を S3 と組み合わせると死ぬ - dev.jgs.me","image":null,"created":1434380400,"updated":1562054615,"lines":[{"id":"5c3c04e24ade4d0000c9e401","text":"io.js の fs.readFileSync を S3 と組み合わせると死ぬ - dev.jgs.me","created":1434380400,"updated":1434380400},{"id":"5c3c04e24ade4d0000c9e403","text":"今日は、運用してる簡単なバッチスクリプトに「挙動がバギーなんだが〜」と問い合わせをもらって調べた。すると、どうやら `fs.readFileSync` でこちらが想定しているファイルを取得できていないことが分かった。","created":1434380400,"updated":1434380400},{"id":"5c3c04e24ade4d0000c9e404","text":"","created":1434380400,"updated":1434380400},{"id":"5c3c04e24ade4d0000c9e405","text":"ブレークダウンしていくと、一定以上のサイズのファイルが途切れて取得されていることが分かった。当該ファイルは EC2 上のサーバに S3 をマウントしていて、`s3fs` 経由でファイルを参照していた。","created":1434380400,"updated":1434380400},{"id":"5c3c04e24ade4d0000c9e406","text":"","created":1434380400,"updated":1434380400},{"id":"5c3c04e24ade4d0000c9e407","text":"試しにそのファイルを `cp` でローカルにコピーして read の権限を与えてやるとこちらが想定している通りのデータを取得することができた。まじかー。。。","created":1434380400,"updated":1434380400},{"id":"5c3c04e24ade4d0000c9e408","text":"","created":1434380400,"updated":1434380400},{"id":"5c3c04e24ade4d0000c9e409","text":"たぶん `s3fs` の問題だろうから深入りせずに","created":1434380400,"updated":1434380400},{"id":"5c3c04e24ade4d0000c9e40a","text":"","created":1434380400,"updated":1434380400},{"id":"5c3c04e24ade4d0000c9e40b","text":"code: (LiveScript)","created":1434380400,"updated":1434380400},{"id":"5c3c04e24ade4d0000c9e40c","text":" ...","created":1434380400,"updated":1434380400},{"id":"5c3c04e24ade4d0000c9e40d","text":" execSync \"cp #{s3Path} #{tmpPath}\"","created":1434380400,"updated":1434380400},{"id":"5c3c04e24ade4d0000c9e40e","text":" execSync \"chmod +r #{tmpPath}\"","created":1434380400,"updated":1434380400},{"id":"5c3c04e24ade4d0000c9e40f","text":" readFileSync tmpPath","created":1434380400,"updated":1434380400},{"id":"5c3c04e24ade4d0000c9e410","text":" ...","created":1434380400,"updated":1434380400},{"id":"5c3c04e24ade4d0000c9e411","text":"","created":1434380400,"updated":1434380400},{"id":"5c3c04e24ade4d0000c9e412","text":"というアレゲな対応になってしまった...。","created":1434380400,"updated":1434380400},{"id":"5c3c04e24ade4d0000c9e413","text":"","created":1434380400,"updated":1434380400},{"id":"5c3c04e24ade4d0000c9e414","text":"[* original: http://dev.jgs.me/2015/06/16/node-readfilesync-with-s3]","created":1434380400,"updated":1434380400},{"id":"5c3c04e24ade4d0000c9e415","text":"#20150616 #0616","created":1434380400,"updated":1562054615},{"id":"5d1b0fd14ade4d0000403020","text":"","created":1562054610,"updated":1562054610}]}