{"id":"6402fcb2b27546001c785afb","title":"TrueNAS で作成したストレージを iSCSI 経由でマウントする","image":null,"created":1677917362,"updated":1677917368,"lines":[{"id":"6402fcb2b27546001c785afb","text":"TrueNAS で作成したストレージを iSCSI 経由でマウントする","created":1677917362,"updated":1677917362},{"id":"6402fcb24ade4d00004cbea6","text":"from [20230303] #0303","created":1677917362,"updated":1677917368},{"id":"6402fcb24ade4d00004cbea7","text":"[TrueNAS] で作成したストレージを [iSCSI] 経由でマウントする","created":1677917362,"updated":1677917362},{"id":"6402fcb24ade4d00004cbea8","text":"\t情報系の出だけど、こういう話には全く疎くて調べ調べでようやっと [Proxmox] 上の [Ubuntu] の VM でマウントできた","created":1677917362,"updated":1677917362},{"id":"6402fcb24ade4d00004cbea9","text":"\tTrueNAS の Web GUI から Portals, Initiators Groups(これは一旦 Allow All Initiators), Targets, Extents, Associated Targets をそれぞれ適当に作成していく","created":1677917362,"updated":1677917362},{"id":"6402fcb24ade4d00004cbeaa","text":"\tVM で `iscsiadm` を叩けばいいんだけど、`/var/run/iscsi` なんたらが root になってるのでいちいち sudo をつけないとパーミッションで弾かれる","created":1677917362,"updated":1677917362},{"id":"6402fcb24ade4d00004cbeab","text":"\t\t`-m discovery -t sendtargets -p <IP>` でディスカバリ","created":1677917362,"updated":1677917362},{"id":"6402fcb24ade4d00004cbeac","text":"\t\t`-m node -L all` でログイン","created":1677917362,"updated":1677917362},{"id":"6402fcb24ade4d00004cbead","text":"\t\t`-m session --op show` を叩いてから `sudo dmesg` で様子がわかる","created":1677917362,"updated":1677917362},{"id":"6402fcb24ade4d00004cbeae","text":"\t`sudo fdisk -l /dev/<name>` で様子を確認してから fdisk でパーティションを作る","created":1677917362,"updated":1677917362},{"id":"6402fcb24ade4d00004cbeaf","text":"\t`sudo mkfs.ext4 /dev/<name>` でフォーマット","created":1677917362,"updated":1677917362},{"id":"6402fcb24ade4d00004cbeb0","text":"\t`sudo mount -t ext4 /dev/<name> /mnt/<target>` でマウントできる","created":1677917362,"updated":1677917362},{"id":"6402fcb24ade4d00004cbeb1","text":"\tマウントしたら `chown <user>:<user> /mnt/<target>` で権限を変えておくと以降 sudo 不要にできる","created":1677917362,"updated":1677917362},{"id":"6402fcb24ade4d00004cbeb2","text":"\tこれで適当に当該ディレクトリに書き込んだりすると反映されるようになった","created":1677917362,"updated":1677917362},{"id":"6402fcb24ade4d00004cbeb3","text":"\tただ、[mac] からだと iSCSI でマウントできない(プロプラのソフトでやる気がありそうなのはあるっぽいが...)っぽくて [SMB] でいいんじゃねって気もしなくもない","created":1677917362,"updated":1677917362},{"id":"6402fcb24ade4d00004cbeb4","text":"\t[Windows] では iSCSI いけるようだが、今度は [ext4] で困るになりそう","created":1677917362,"updated":1677917362},{"id":"6402fcb24ade4d00004cbeb5","text":"\t\t[WSL] で Ubuntu いれて、そこでマウントすればなんとかなったりするかな？","created":1677917362,"updated":1677917362},{"id":"6402fcb24ade4d00004cbeb6","text":"\t....といったとこまでやって、別のマシンでマウントしたらすげー勢いで IO error が発生した","created":1677917362,"updated":1677917362},{"id":"6402fcb24ade4d00004cbeb7","text":"\t調べてみると論理ボリュームを作ってやらないといけないみたい","created":1677917362,"updated":1677917362},{"id":"6402fcb24ade4d00004cbeb8","text":"\t\t`sudo umount /dev/<name>` でアンマウント","created":1677917362,"updated":1677917362},{"id":"6402fcb24ade4d00004cbeb9","text":"\t\t`sudo fdisk /dev/<name>` でパーティションを切り直す","created":1677917362,"updated":1677917362},{"id":"6402fcb24ade4d00004cbeba","text":"\t\t`sudo pvcreate /dev/<name>` で物理ボリュームを作る","created":1677917362,"updated":1677917362},{"id":"6402fcb24ade4d00004cbebb","text":"\t\t`sudo vgcreate <group_name> /dev/<name>` でボリュームグループ？を作る `vgdisplay` で確認","created":1677917362,"updated":1677917362},{"id":"6402fcb24ade4d00004cbebc","text":"\t\t`sudo lvcreate -l <n> -n <logic_name> <group_name>` で論理ボリューム？を作る","created":1677917362,"updated":1677917362},{"id":"6402fcb24ade4d00004cbebd","text":"\t\tそうすると `/dev/<group_name>/<logic_name>` ができるので、`mkfs.ext4` でフォーマット","created":1677917362,"updated":1677917362},{"id":"6402fcb24ade4d00004cbebe","text":"\t........とおもったんだけど、そもそも iSCSI だとターゲットに対してイニシエータが対になってるから同時に複数のホストで接続しても先勝ちで接続されたホストの変更が優先されて、そいつがアンマウントしたら次のマウントした奴にその変更が反映される....的な感じみたい","created":1677917362,"updated":1677917362},{"id":"6402fcb24ade4d00004cbebf","text":"\t\t(何も調べずにやっていた人)","created":1677917362,"updated":1677917362},{"id":"6402fcb24ade4d00004cbec0","text":"\t結論: SMB でよさそう","created":1677917362,"updated":1677917362},{"id":"6402fcb24ade4d00004cbec1","text":"","created":1677917362,"updated":1677917362}]}