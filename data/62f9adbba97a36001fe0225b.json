{"id":"62f9adbba97a36001fe0225b","title":"Scrapbox であそぼう2022夏","image":null,"created":1660530108,"updated":1660530332,"lines":[{"id":"62f9adbba97a36001fe0225b","text":"Scrapbox であそぼう2022夏","created":1660530108,"updated":1660530108},{"id":"62f9adbb4ade4d00008639c4","text":"from [20220814] #0814","created":1660530108,"updated":1660530112},{"id":"62f9adbb4ade4d00008639c5","text":"[Scrapbox] であそぼう2022夏","created":1660530108,"updated":1660530114},{"id":"62f9adbb4ade4d00008639c6","text":"\t[UserScript] でまだまだやれそうなことがわかったのでいろいろ試す","created":1660530108,"updated":1660530118},{"id":"62f9adbb4ade4d00008639c7","text":"\tまずは素の[コードブロック]だと書きにくいのでどうにか [VSCode] から書けないか模索する","created":1660530108,"updated":1660530126},{"id":"62f9adbb4ade4d00008639c8","text":"\t最初は [GhostText] っていう Chrome の拡張と VSCode の拡張を組み合わせて試してみたけど、割と予想通り Scrapbox が素の [textarea] じゃないので入力が壊れてダメだった","created":1660530108,"updated":1660530138},{"id":"62f9adbb4ade4d00008639c9","text":"\tそれじゃあ [Codespaces] から js を配信して開発中は UserScript にその URL を入れればよいのでは？と試してみたがこれもまあ予想通り [CSP] にブロックされて読み込んでくれなかった","created":1660530108,"updated":1660530151},{"id":"62f9adbb4ade4d00008639ca","text":"\t\t[deno] で [esbuild] を watch で起動して、std/http/server で配信するだけというお手軽サーバーを作ったのだが....","created":1660530108,"updated":1660530158},{"id":"62f9adbb4ade4d00008639cb","text":"\tそうなったらもう[Chrome拡張]ですわーということで腰を上げたものの、[ManifestV3] 対応絶対だるそうだな〜...なんか手軽に環境立ち上げられへんかな〜...とおもってたら [vite] の plugin に [@crxjs/vite-plugin] てやつがあって、これに適当に設定を書いたら立ち上がるようになった","created":1660530108,"updated":1660530178},{"id":"62f9adbb4ade4d00008639cc","text":"\t\t前にトライしてた時に [content_script] で [web_accessible_resources] に指定した js を script としてインジェクションするという方法でスクリプトをブチ込んでいたが、どうやらUserScriptが読み込まれるタイミングと合わないっぽくて、謎に [setTimeout] をつけると動くようになるという状態になってしまった","created":1660530108,"updated":1660530196},{"id":"62f9adbb4ade4d00008639cd","text":"\t\tしかし、これがCSP的にOKなんであれば UserScript に `chrome-extension://` で埋め込むスクリプトを読むようにすればよいのでは...?と試してみると動いた","created":1660530108,"updated":1660530108},{"id":"62f9adbb4ade4d00008639ce","text":"\t\t\tvite のビルド結果はエントリーポイントのファイルに `import` が書いてあるだけなんだけど、crxjs は割と豪快に web_accessible_resources に全てのアセットを指定しているのでネイティブの import でファイルが読まれてくるので問題なかった","created":1660530108,"updated":1660530108},{"id":"62f9adbb4ade4d00008639cf","text":"\tせっかくなのでちゃんと型ほしいなあ、とおもったら https://github.com/scrapbox-jp/types があったのでこいつを使おうかと","created":1660530108,"updated":1660530108},{"id":"62f9adbb4ade4d00008639d0","text":"\t\tしかし、deno 向けに書かれているのでそのままだと vite から使えないので [dnt] で変換してみることに","created":1660530108,"updated":1660530214},{"id":"62f9adbb4ade4d00008639d1","text":"\t\t\tdeno.ns が解決できない問題に遭遇したがそっと消すとビルド自体は通ったので適当に publish してみる","created":1660530108,"updated":1660530108},{"id":"62f9adbb4ade4d00008639d2","text":"\t\t\t...が Scrapbox の型が [any] になってしまう問題に遭遇","created":1660530108,"updated":1660530223},{"id":"62f9adbb4ade4d00008639d3","text":"\t\t\t\tこいつがなかなかやっかいで、deno 側の型定義は node の [events] から引っ張ってきてて、[EventEmitter] が class で export されているせいなのかなんなのか、うまくそのままの変換では動かず","created":1660530108,"updated":1660530231},{"id":"62f9adbb4ade4d00008639d4","text":"\t\t\t\tかといって vite には events なんてモジュールはないので無理やり型フォージもできず","created":1660530108,"updated":1660530108},{"id":"62f9adbb4ade4d00008639d5","text":"\t\t\t\tなぜなのか全くわからないけど、呼び出すモジュール側で EventEmitter と Scrapbox を別々で読んできたらこっちではうまく解決できるのでとりあえずのワークアラウンドとしてこれでいくことにした","created":1660530108,"updated":1660530108},{"id":"62f9adbb4ade4d00008639d6","text":"\tやっとこ動くようになったら、最後は esbuild で1つのファイルにバンドルしてそいつを chrome-extension の URL と差し替えてやれば完成である","created":1660530108,"updated":1660530108},{"id":"62f9adbb4ade4d00008639d7","text":"\tこの雑な manifest で動くってことは、実は deno でビルドして watch しとけば開発できるのでは...?とおもむろに [deno bundle] でビルドするようにして、dist には manifest と1つの js がある状態で試してみると動いた","created":1660530108,"updated":1660530247},{"id":"62f9adbb4ade4d00008639d8","text":"\t\tこいつぁーいろいろ作れるな〜と早速 UI もあるような UserScript を作ってみようと","created":1660530108,"updated":1660530108},{"id":"62f9adbb4ade4d00008639d9","text":"\t\t[fresh] を試していた時になんとなく [preact] 不信になってしまったので、ここは多少フットプリントでかくてもいいから [react] でたのもう！と react でかる〜く組んでみた","created":1660530108,"updated":1660530268},{"id":"62f9adbb4ade4d00008639da","text":"\t\t\t途中 hook が import できない謎状態に陥ったが、[import_map] をコネコネしてたらなんか治った、なんで治ったのかはよくわからない","created":1660530108,"updated":1660530290},{"id":"62f9adbb4ade4d00008639db","text":"\t\tとりあえず簡単なスクリプト群ができあがったので、ビルドした js を esbuild で minify してコピペしようとしたら Too large! って言われてペーストできなかった","created":1660530108,"updated":1660530108},{"id":"62f9adbb4ade4d00008639dc","text":"\tなるほどそういう制限もあるわけね〜...と react をやめて [svelte] だとか [solid] あたりでミニマルなフットプリントでどうにかできないか調べてみたけど、未知のライブラリを deno でバンドルしてもっていける未来が想像できなかったので諦めた","created":1660530108,"updated":1660530301},{"id":"62f9adbb4ade4d00008639dd","text":"\t代わりに適当な UI で textarea を出現させて、そこに貼りつけたコードをチョップしてストリームで挿入できないか検討した","created":1660530108,"updated":1660530108},{"id":"62f9adbb4ade4d00008639de","text":"\t\t雑に試したら動いたので、まずは1文字ずつ wait を挟みながら実行したのだが、scrapbox は入力中はバッファして、ある程度入力が終わったら変更を反映する〜みたいな挙動をするので、1文字ずつだーっとやるよりはもう少し大きいチャンクで貼りつけていくのがよさそうだった","created":1660530108,"updated":1660530108},{"id":"62f9adbb4ade4d00008639df","text":"\t\t今度はチャンクを大きめにして、待ち時間を気持ち長めに設定したらどんどん書き足されていくようにはなったけどコードブロックからはみだしてしまう問題が発生してしまった","created":1660530108,"updated":1660530108},{"id":"62f9adbb4ade4d00008639e0","text":"\t\tこれは想像だけど、insert する時に `\\n` だと特段処理が走らないけど、Enter の press で改行されるような気がする...","created":1660530108,"updated":1660530108},{"id":"62f9adbb4ade4d00008639e1","text":"\t\tとおもって `\\n` で分割して Enter を都度入力させながら試してみるとついに動くようになった","created":1660530108,"updated":1660530108},{"id":"62f9adbb4ade4d00008639e2","text":"\tそういえば途中 [Chakra UI] 試したんだが、バンドルに失敗するようになっちゃって断念した","created":1660530108,"updated":1660530320},{"id":"62f9adbb4ade4d00008639e3","text":"\t\tdeno界で使われている [twind] を使ってみてるけど、インテリセンスが効いたり効かなかったり(大抵効かない)で困っている","created":1660530108,"updated":1660530324},{"id":"62f9adbb4ade4d00008639e4","text":"\t\tあと成果物のコードをチラ見したけど、んーなんかそういう感じかーみたいな...","created":1660530108,"updated":1660530108},{"id":"62f9adbb4ade4d00008639e5","text":"\t\t[tailwind] を cli で生成して UserCSS にぶち込む方式なんかどうかなあ...?","created":1660530108,"updated":1660530332},{"id":"62f9adbb4ade4d00008639e6","text":"\t\t\tplay cdn 使えるといいんだけどな...","created":1660530108,"updated":1660530108},{"id":"62f9adbb4ade4d00008639e7","text":"","created":1660530108,"updated":1660530108}]}