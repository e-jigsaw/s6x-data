{"id":"63267c318c63ea0023b6bb9d","title":"ローコストでつくる discord bot","image":"https://gyazo.com/c66143c4f15f23c7f97c845163ee528e/raw","created":1663466546,"updated":1663466551,"lines":[{"id":"63267c318c63ea0023b6bb9d","text":"ローコストでつくる discord bot","created":1663466546,"updated":1663466546},{"id":"63267c314ade4d0000f188a0","text":"from [20220915] #0915","created":1663466546,"updated":1663466551},{"id":"63267c314ade4d0000f188a1","text":"ローコストでつくる discord bot","created":1663466546,"updated":1663466546},{"id":"63267c314ade4d0000f188a2","text":"\t[スプラトゥーン3]まわりでやってる人が多くて、いろんなクラスタの人たちと遊べて楽しい","created":1663466546,"updated":1663466546},{"id":"63267c314ade4d0000f188a3","text":"\tゲームのウデマエの方はてんでなんだけど集まってワイワイゲームするのがシンプルに楽しいので、エンジョイな人たちとスムーズ楽しめるようになんらかのサポートツールを作ってみようかなと","created":1663466546,"updated":1663466546},{"id":"63267c314ade4d0000f188a4","text":"\t...というのは建前で、[discord] の新しい API を触ってみたかったのでいろいろ試してみたの巻","created":1663466546,"updated":1663466546},{"id":"63267c314ade4d0000f188a5","text":"\t\tソースは https://github.com/e-jigsaw/dika3","created":1663466546,"updated":1663466546},{"id":"63267c314ade4d0000f188a6","text":"\tdiscord のこれまでの bot は listen するサーバがどっかに常時建ってないといけないので面倒だったが、ある程度妥協すれば bot っぽいものを作れるようになっていた","created":1663466546,"updated":1663466546},{"id":"63267c314ade4d0000f188a7","text":"\t\thttps://discord.com/developers/docs/interactions/application-commands","created":1663466546,"updated":1663466546},{"id":"63267c314ade4d0000f188a8","text":"\t\tじゃあ [deno deploy] で簡単に bot っぽいものが作れるジャンということで [deno] で実装する","created":1663466546,"updated":1663466546},{"id":"63267c314ade4d0000f188a9","text":"\tアプリケーションを作成して、OAuth2 URL Generator から `applications.commands` にだけチェックをいれた URL を作成して admin の権限をもってるサーバに放り込む","created":1663466546,"updated":1663466546},{"id":"63267c314ade4d0000f188aa","text":"\t[https://gyazo.com/c66143c4f15f23c7f97c845163ee528e]","created":1663466546,"updated":1663466546},{"id":"63267c314ade4d0000f188ab","text":"\tアプリケーションの intersection の endpoint の登録をすると ping が飛んでくるので pong してやらないと登録されなかった","created":1663466546,"updated":1663466546},{"id":"63267c314ade4d0000f188ac","text":"\t\thttps://github.com/e-jigsaw/dika3/blob/4967e60650214c19bb94aabaff1409e1eb0a70a6/src/index.ts こんな感じのコードを [deno deploy] にあげておいたら通った","created":1663466546,"updated":1663466546},{"id":"63267c314ade4d0000f188ad","text":"\t\tdeno deploy の env に discord の public key を登録しておく","created":1663466546,"updated":1663466546},{"id":"63267c314ade4d0000f188ae","text":"\tコマンドの登録は https://github.com/e-jigsaw/dika3/blob/f07abc07f02440046159380f7d6b3454499402b8/src/register.ts こういう感じで、bot の token と guild(サーバ) の ID を指定して登録する","created":1663466546,"updated":1663466546},{"id":"63267c314ade4d0000f188af","text":" \tグローバルに登録ということもできるらしいが、時間がかかったりすることもあるらしい","created":1663466546,"updated":1663466546},{"id":"63267c314ade4d0000f188b0","text":"\tすると、メッセージのところで右クリックした際に `アプリ` ってセクションのところに任意のコマンドを生やすことができる","created":1663466546,"updated":1663466546},{"id":"63267c314ade4d0000f188b1","text":"\t[https://gyazo.com/9f7edbceb740a67081cdff67d456b466]","created":1663466546,"updated":1663466546},{"id":"63267c314ade4d0000f188b2","text":"\t今回は各種バトルの今と次のマップを返すコマンドをつくる","created":1663466546,"updated":1663466546},{"id":"63267c314ade4d0000f188b3","text":"\t[えむおん]センパイが突貫で API https://spla3.yuu26.com/ を作ってくれているのでこいつを使わせてもらう","created":1663466546,"updated":1663466546},{"id":"63267c314ade4d0000f188b4","text":"\tまずはコマンドが実行されたらレスポンスを返す部分で","created":1663466546,"updated":1663466546},{"id":"63267c314ade4d0000f188b5","text":"\t\thttps://github.com/e-jigsaw/dika3/blob/4967e60650214c19bb94aabaff1409e1eb0a70a6/src/index.ts#L40-L48","created":1663466546,"updated":1663466546},{"id":"63267c314ade4d0000f188b6","text":"\t\tApplicationCommand = 2 でリクエストが飛んでくるので適切な json を返してやるとそれがメッセージとして表示される仕組み","created":1663466546,"updated":1663466546},{"id":"63267c314ade4d0000f188b7","text":"\t\thttps://discord.com/developers/docs/interactions/receiving-and-responding","created":1663466546,"updated":1663466546},{"id":"63267c314ade4d0000f188b8","text":"\t[https://gyazo.com/e8f48b3b3a3011b8adef302105970b0f]","created":1663466546,"updated":1663466546},{"id":"63267c314ade4d0000f188b9","text":"\tなるほどね","created":1663466546,"updated":1663466546},{"id":"63267c314ade4d0000f188ba","text":"\tレスポンスに components ってのをつけてやるとボタンやセレクトメニュー、テキスト入力なんかを返せる","created":1663466546,"updated":1663466546},{"id":"63267c314ade4d0000f188bb","text":"\t[https://gyazo.com/8bff2fe0bd21d264bb01b61a88deccf8]","created":1663466546,"updated":1663466546},{"id":"63267c314ade4d0000f188bc","text":"\tので、最初は select を2つ返してそれぞれほしい組み合わせを選ぶ式にしてみたが、interaction として返ってくるのは選択されたソレだけなので選択されてない方が何選択されているのかがわからない","created":1663466546,"updated":1663466546},{"id":"63267c314ade4d0000f188bd","text":"\t\tどうにかできないものかと調べてみたのだが、調べた限りでは intersection を cache として保存しておいて時限で突合するみたいな仕組みだったのでなんだかなと","created":1663466546,"updated":1663466546},{"id":"63267c314ade4d0000f188be","text":"\t[https://gyazo.com/576a23f98b9f9cdc174fc2abecf6e1ae]","created":1663466546,"updated":1663466546},{"id":"63267c314ade4d0000f188bf","text":"\tしょうがないので [Midjourny] みたいにボタンのテーブルを作る方式にした","created":1663466546,"updated":1663466546},{"id":"63267c314ade4d0000f188c0","text":"\tまあボタン6コなら許容だろう...","created":1663466546,"updated":1663466546},{"id":"63267c314ade4d0000f188c1","text":"\t各ボタンに `custom_id` を指定しておいて、それを基に spla3 API を叩いて情報を返す","created":1663466546,"updated":1663466546},{"id":"63267c314ade4d0000f188c2","text":"\t\tレスポンスには `embeds` というフィールドがあって、ここに画像やらなんやら仕込める","created":1663466546,"updated":1663466546},{"id":"63267c314ade4d0000f188c3","text":"\t\t\thttps://discord.com/developers/docs/interactions/receiving-and-responding#interaction-response-object-interaction-callback-data-structure","created":1663466546,"updated":1663466546},{"id":"63267c314ade4d0000f188c4","text":"\t[https://gyazo.com/7fdbe7d5db96cb3c302579f1a3cd5434]","created":1663466546,"updated":1663466546},{"id":"63267c314ade4d0000f188c5","text":"\tイイ感じ","created":1663466546,"updated":1663466546},{"id":"63267c314ade4d0000f188c6","text":"\t\tちなみに地図情報は手作業で登録していってここが一番だるかった10マップx5ルールである...","created":1663466546,"updated":1663466546},{"id":"63267c314ade4d0000f188c7","text":"\tでも毎回右クリックして実行するのもだるいなということに気付いたので","created":1663466546,"updated":1663466546},{"id":"63267c314ade4d0000f188c8","text":"\t[https://gyazo.com/eba714e7c00d3f526be57861eb69ea12]","created":1663466546,"updated":1663466546},{"id":"63267c314ade4d0000f188c9","text":"\tレスポンスには components も同居できるのでアンサーにもボタンを仕込んでやれば(これも midjourney 方式)楽チンになった","created":1663466546,"updated":1663466546},{"id":"63267c314ade4d0000f188ca","text":"","created":1663466546,"updated":1663466546}]}